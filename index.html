<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>GMV Young Life — Leaderboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/yl-logo.png">
    <style>
      :root { --bg:#f5f7fb; --card:#ffffff; --border:#e5e7eb; --text:#0b1220; --muted:#6b7280; --brand:#0f2e4d; --accent:#c7d301; --accent2:#1bb3a9; }
      *{box-sizing:border-box}
      body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
      .wrap{max-width:1100px;margin:0 auto;padding:24px}

      /* HERO */
      .hero{padding:8px 0}
      .hero-brand{display:flex;align-items:center;gap:12px}
      .hero-logo{height:64px;width:auto;display:block}
      .hero-title{margin:0;font-size:clamp(28px,5vw,48px);line-height:1.1;font-weight:800}
      .hero-sub{margin:6px 0 0;font-size:clamp(16px,3vw,22px);font-weight:600;color:var(--text)}

      /* CARDS / BUTTONS */
      .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 4px rgba(10,10,10,.04)}
      .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
      .btn{padding:8px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer;font-size:14px}
      .btn[aria-pressed="true"]{background:var(--brand);color:#fff;border-color:var(--brand)}
      .btn-cta{display:inline-block;padding:10px 14px;border-radius:12px;font-weight:600;text-decoration:none;background:var(--brand);color:#fff;border:1px solid var(--brand)}
      .btn-cta:hover{filter:brightness(.95)}
      .muted{color:var(--muted);font-size:12px}
      .errbox{display:none;background:#fee2e2;border:1px solid #fecaca;color:#b91c1c;padding:8px 12px;border-radius:10px;margin:12px 0;font-size:13px}

      /* MAIN GRID */
      .main-grid{display:grid;grid-template-columns:minmax(0,2fr) minmax(260px,1fr);gap:16px;align-items:start;margin-top:8px}
      @media(max-width:900px){.main-grid{grid-template-columns:1fr}}
      .chart{height:460px;position:relative}
      .svg-wrap{width:100%;height:100%;padding:12px}
      svg{width:100%;height:100%;display:block}
      g.bar{will-change:transform}
      .nodata{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--muted)}

      .aside{padding:16px}
      .aside h2{margin:0 0 8px;font-size:18px}
      .qr-wrap{display:flex;align-items:center;justify-content:center;padding:8px;border:1px dashed var(--border);border-radius:12px;background:#fff;margin:8px 0 12px}
      .qr{width:100%;max-width:140px;height:auto}
      .small{font-size:11px}

      /* IMPACT STATS */
      .impact{margin-top:16px;padding:16px}
      .stats-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px}
      @media(max-width:1100px){.stats-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
      @media(max-width:700px){.stats-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
      .stat{position:relative;background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px 14px}
      .stat::before{content:"";position:absolute;left:0;top:0;height:4px;width:100%;background:var(--accent);border-top-left-radius:14px;border-top-right-radius:14px}
      .stat-num{font-size:clamp(24px,4vw,40px);font-weight:800;line-height:1;margin-top:8px}
      .stat-label{margin-top:6px;font-size:12px;color:var(--muted)}

      /* STORIES (unified) */
      .stories{margin-top:16px;padding:16px}
      .story-list{display:flex;flex-direction:column;gap:16px}
      .story-row{display:grid;grid-template-columns:minmax(0,0.9fr) minmax(0,1.1fr);gap:16px;align-items:center}
      .story-row.reverse{grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr)}
      .story-img{width:100%;height:auto;display:block;border-radius:12px;aspect-ratio:3/2;object-fit:cover;max-height:220px}
      .story-copy h3{margin:0 0 8px;font-size:18px}
      .story-copy p{margin:0 0 10px;line-height:1.5}
      .caption{margin-top:6px;font-size:12px;color:var(--muted)}
      @media(max-width:900px){.story-row,.story-row.reverse{grid-template-columns:1fr}}
    </style>

    <!-- React + ReactDOM + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <section class="hero">
        <div class="hero-brand">
          <img src="yl-logo.png" class="hero-logo" alt="Young Life logo" width="64" height="64" />
          <h1 class="hero-title">GMV Young Life</h1>
        </div>
        <h2 class="hero-sub">Leaderboard</h2>
      </section>

      <div id="error" class="errbox"></div>

      <div class="main-grid">
        <div id="root"></div>
        <aside class="aside card">
          <div class="aside-inner">
            <h2>Support GMV Young Life</h2>
            <p class="muted">Your gift fuels leaders, clubs, and camps across Butler County.</p>
            <div class="qr-wrap">
              <img src="qr.png" alt="Donate QR code" class="qr" width="140" height="140" loading="lazy" />
            </div>
            <a id="donate-link" class="btn-cta" href="https://giving.younglife.org/legacyleaders" target="_blank" rel="noopener">Give Online</a>
            <p class="muted small">Scan the code or tap the button.</p>
          </div>
        </aside>
      </div>

      <section class="impact card" aria-labelledby="impact-heading">
        <h3 id="impact-heading" class="muted" style="margin:0 0 8px;">Impact at a Glance</h3>
        <div class="stats-grid">
          <div class="stat"><div class="stat-num">15</div><div class="stat-label">Ministries</div></div>
          <div class="stat"><div class="stat-num">86</div><div class="stat-label">Volunteer Leaders</div></div>
          <div class="stat"><div class="stat-num">691</div><div class="stat-label">Kids went to Fall Weekend</div></div>
          <div class="stat"><div class="stat-num">563</div><div class="stat-label">Kids went to Summer Camp</div></div>
          <div class="stat"><div class="stat-num">30%</div><div class="stat-label">More campers this year</div></div>
        </div>
      </section>

      <!-- STORIES unified -->
      <section class="stories card" aria-labelledby="stories-heading">
        <h3 id="stories-heading" class="muted" style="margin:0 0 8px;">Stories</h3>
        <div class="story-list">

          <div class="story-row">
            <figure style="margin:0">
              <img src="leaders.jpg" alt="GMV Young Life leaders on the field" class="story-img" width="1200" height="800" />
              <figcaption class="caption">GMV Young Life leaders • Fall Leader Retreat 2025</figcaption>
            </figure>
            <div class="story-copy">
              <h3>Why Your Gift Matters</h3>
              <p>Every week across Butler County, leaders show up for students—at lunch tables, at practice, and at club. This year, 86 volunteer leaders served across 15 ministries, helping 691 kids get to fall weekend and 563 to summer camp—places where many heard about Jesus’ love for the first time.</p>
              <p>Your gift fuels a leader’s training, a bus seat, and a return ride to a community that keeps showing up long after camp ends. Help us keep saying yes to every school and every kid.</p>
            </div>
          </div>

          <div class="story-row reverse">
            <div class="story-copy">
              <h3>Wild Growth in WyldLife</h3>
              <p>East WyldLife launched Wild Wednesdays for the first time in years with over 40 kids showing up for bible study to hear about Jesus in a language they can understand.</p>
              <p>This is one of three current WyldLife clubs with the hopes of launching one or two more this year.</p>
            </div>
            <figure style="margin:0">
              <img src="wyldlife.jpg" alt="Middle school WyldLife club gathered in a living room" class="story-img" loading="lazy" width="1200" height="900" />
              <figcaption class="caption">Wild Wednesday - Fall 2025</figcaption>
            </figure>
          </div>

          <div class="story-row">
            <figure style="margin:0">
              <img src="dean.jpg" alt="Student smiling in the back of a Jeep after club" class="story-img" loading="lazy" width="1200" height="900" />
              <figcaption class="caption">Life to the Full</figcaption>
            </figure>
            <div class="story-copy">
              <h3>Kids Meeting Jesus</h3>
              <p>Dean was a freshman at Talawanda when he met Chris Light. After Fall Weekend, Dean was interested in Jesus, but didn't feel like he could commit.</p>
              <p>He came to camp, prayed to accept Jesus, and this fall got baptized. Dean is stepping into the full life Jesus promised.</p>
            </div>
          </div>

        </div>
      </section>

      <footer id="foot" class="muted"></footer>
    </div>

    <!-- CHART APP -->
    <script type="text/babel" data-presets="env,react">
      const RISE_MS=4800,PAUSE_BEFORE_REORDER_MS=1500,REORDER_MS=1500;
      (function(){const b=document.getElementById('error');function s(m){b.style.display='block';b.textContent='Error: '+m;} window.addEventListener('error',e=>s(e.message)); window.addEventListener('unhandledrejection',e=>s(e.reason&&e.reason.message?e.reason.message:String(e.reason)));})();
      const {useEffect,useMemo,useRef,useState}=React;
      function toNumber(x){ if(x==null) return 0; if(typeof x==='number') return Number.isFinite(x)?x:0; const s=String(x).trim().replace(/[$,]/g,'').replace(/%/g,''); const n=Number(s); return Number.isFinite(n)?n:0; }
      const METRICS=[{key:"totalGifts",label:"Total Gifts",fmt:v=>"$"+Math.round(Number(v)).toLocaleString()},{key:"percentGivers",label:"% of Givers",fmt:v=>Math.round(Number(v))+"%"}];
      const COLORS=["#f97316","#38bdf8","#34d399","#a78bfa","#fde047","#60a5fa","#22d3ee","#f59e0b","#84cc16","#14b8a6","#ec4899","#6366f1","#eab308","#10b981","#3b82f6"];
      const BASE_YEAR=1999; const colorForYear=y=>COLORS[(((y-BASE_YEAR)%COLORS.length)+COLORS.length)%COLORS.length];
      function niceTicks(max,count=5){ if(max<=0||!isFinite(max))return[0,1]; const rough=max/count; const pow10=Math.pow(10,Math.floor(Math.log10(rough))); let nice=pow10; if(rough/pow10>=5) nice=5*pow10; else if(rough/pow10>=2) nice=2*pow10; const top=Math.ceil(max/nice)*nice; const out=[]; for(let v=0; v<=top+1e-9; v+=nice) out.push(v); return out; }
      const easeOutCubic=t=>1-Math.pow(1-t,3);

      function App(){
        const [metric,setMetric]=useState("totalGifts");
        const [rows,setRows]=useState([]); const [loading,setLoading]=useState(true); const [lastUpdated,setLastUpdated]=useState(null);
        const [animated,setAnimated]=useState([]); const [sorted,setSorted]=useState(false); const [reordering,setReordering]=useState(false);

        // responsive width (rAF throttled)
        const holderRef=useRef(null); const [width,setWidth]=useState(980);
        useEffect(()=>{ let raf=null; const measure=()=>{raf=null; setWidth(holderRef.current?holderRef.current.clientWidth:980)}; const onResize=()=>{ if(raf==null) raf=requestAnimationFrame(measure); }; onResize(); window.addEventListener('resize',onResize); return()=>{ if(raf) cancelAnimationFrame(raf); window.removeEventListener('resize',onResize); }; },[]);

        // fetch + sanitize once
        useEffect(()=>{(async()=>{ try{ setLoading(true); const r=await fetch("/.netlify/functions/leaderboard",{cache:"no-store"}); const json=await r.json(); if(!r.ok) throw new Error(json?.error||"Failed to load"); const arr=Array.isArray(json.rows)?json.rows:[]; const clean=arr.map(row=>({ ...row, year:Number(row.year), totalGifts:toNumber(row.totalGifts), percentGivers:toNumber(row.percentGivers) })); setRows(clean); setLastUpdated(new Date()); } catch(e){ console.error(e); } finally{ setLoading(false); } })(); },[]);
        useEffect(()=>{ if(lastUpdated){ document.getElementById('foot').textContent=`Last updated: ${lastUpdated.toLocaleTimeString()}`; } },[lastUpdated]);

        const targets=useMemo(()=>rows.map(r=>({year:r.year,value:toNumber(r[metric])})),[rows,metric]);
        const yMax=useMemo(()=>{ const max=targets.reduce((m,d)=>Math.max(m,d.value||0),0); return metric==="totalGifts"?Math.max(1000,Math.ceil(max/1000)*1000):100; },[targets,metric]);
        const ticks=useMemo(()=> metric==="totalGifts"?niceTicks(yMax,5):[0,20,40,60,80,100],[yMax,metric]);
        const fmtTick=v=> metric==="totalGifts"?"$"+Math.round(Number(v)).toLocaleString():Math.round(Number(v))+"%";
        const metricObj=METRICS.find(m=>m.key===metric);

        // FLIP bookkeeping
        const rafRef=useRef(null), FLIP_prevX=useRef(new Map()), barRefs=useRef(new Map());
        useEffect(()=>{ barRefs.current=new Map(); },[metric,rows.length]);

        function playRise(){
          if(rafRef.current) cancelAnimationFrame(rafRef.current);
          setSorted(false); setReordering(false); setAnimated(targets.map(t=>({year:t.year,value:0})));
          const start=performance.now();
          function step(now){ const t=Math.min(1,(now-start)/RISE_MS); const eased=easeOutCubic(t); setAnimated(targets.map(tgt=>({year:tgt.year,value:tgt.value*eased}))); if(t<1){ rafRef.current=requestAnimationFrame(step); } else { setTimeout(()=>startReorder(),PAUSE_BEFORE_REORDER_MS); } }
          rafRef.current=requestAnimationFrame(step);
        }
        useEffect(()=>{ if(rows.length) playRise(); },[metric,rows.length]);

        const disp=useMemo(()=>{ const aMap=new Map(animated.map(a=>[a.year,a.value])); const base=rows.map(r=>({...r,value:aMap.get(r.year)||0})); return (sorted?[...base].sort((x,y)=>y.value-x.value):[...base].sort((x,y)=>x.year-y.year)); },[rows,animated,sorted]);

        const H=420, M={top:20,right:20,bottom:70,left:70}; const innerW=Math.max(320,width)-M.left-M.right; const innerH=H-M.top-M.bottom; const n=disp.length||1; const band=innerW/n; const barPad=Math.min(12,band*0.2); const barW=Math.max(2,band-barPad);
        const xPos=i=>M.left+i*band+(band-barW)/2; const yPos=v=>{ const maxV=metric==="totalGifts"?yMax:100; const t=Math.min(1,Math.max(0,(v||0)/(maxV||1))); return M.top+(1-t)*innerH; };

        function startReorder(){ const prev=new Map(); disp.forEach((d,i)=>prev.set(d.year,xPos(i)+barW/2)); FLIP_prevX.current=prev; setSorted(true); setReordering(true); }
        useEffect(()=>{ if(!reordering) return; requestAnimationFrame(()=>{ disp.forEach((d,i)=>{ const node=barRefs.current.get(d.year); if(!node) return; const prevX=FLIP_prevX.current.get(d.year)||0; const newX=xPos(i)+barW/2; const delta=prevX-newX; node.style.transition="none"; node.style.transform=`translate(${delta}px,0px)`; }); void document.body.offsetHeight; disp.forEach(d=>{ const node=barRefs.current.get(d.year); if(!node) return; node.style.transition=`transform ${REORDER_MS}ms cubic-bezier(0.22,1,0.36,1)`; node.style.transform="translate(0px,0px)"; }); setTimeout(()=>setReordering(false),REORDER_MS+100); }); },[reordering,width,disp]);

        const chartWidth=Math.max(320,width);

        return (
          <div>
            <header className="card" style={{padding:"16px"}}>
              <div className="row" role="group" aria-label="Choose metric">
                {METRICS.map(m=> (
                  <button key={m.key} className="btn" aria-pressed={metric===m.key} aria-controls="chart" onClick={()=>setMetric(m.key)}>{m.label}</button>
                ))}
              </div>
            </header>

            <section className="card chart" aria-live="polite">
              {(!rows.length && !loading) && <div className="nodata">No data available.</div>}
              <div ref={holderRef} className="svg-wrap">
                <svg id="chart" viewBox={`0 0 ${chartWidth} ${H}`} preserveAspectRatio="xMidYMid meet" role="img" aria-label="Leaderboard bar chart">
                  {ticks.map((t,i)=>{ const y=yPos(t); return(<g key={`tick-${i}`}><line x1={M.left} y1={y} x2={chartWidth-M.right} y2={y} stroke="#eee"/><text x={M.left-10} y={y+4} textAnchor="end" fontSize="12" fill="#111">{fmtTick(t)}</text></g>)})}
                  <line x1={M.left} y1={H-M.bottom} x2={chartWidth-M.right} y2={H-M.bottom} stroke="#ddd" />
                  {disp.map((d,i)=>{ const x=xPos(i), y=yPos(d.value), h=(H-M.bottom)-y, color=colorForYear(d.year), cx=x+barW/2; const showValue=h>18; return(
                    <g key={d.year} className="bar" ref={el=>{ if(el) barRefs.current.set(d.year,el); }}>
                      <rect x={x} y={y} width={barW} height={Math.max(0,h)} fill={color} rx="8" ry="8">
                        <title>{`Class of ${d.year}\n${metricObj.label}: ${metricObj.fmt(d.value)}`}</title>
                      </rect>
                      {showValue && (<text x={cx} y={y-6} textAnchor="middle" fontSize="11" fill="#111">{metricObj.fmt(d.value)}</text>)}
                      <text x={cx} y={H-M.bottom+14} fontSize="10" fill="#111" textAnchor="end" transform={`rotate(-45 ${cx} ${H-M.bottom+14})`}>{d.year}</text>
                    </g>
                  );})}
                </svg>
              </div>
            </section>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
